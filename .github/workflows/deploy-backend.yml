name: Deploy Backend (VPS Build)

on:
  release:
    types: [published]

env:
  VERSION: ${{ github.event.release.tag_name }}
  TARGET: ${{ github.event.release.target_commitish }}
  AUTHOR: ${{ github.event.release.author.login }}
  RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    # ==========================================
    # STEP 1: Deployment Started Notification
    # ==========================================
    - name: ğŸ“¢ Notify Deployment Started
      run: |
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d message_thread_id="2" \
          -d parse_mode="Markdown" \
          -d text="ğŸš€ *Backend Deployment Started*

        ğŸ“¦ *Project:* OM Messenger Backend  
        ğŸŒ *Environment:* Production  
        ğŸ·ï¸ *Version:* ${{ env.VERSION }}  
        ğŸ§© *Target:* ${{ env.TARGET }}  
        ğŸ‘¤ *Triggered by:* ${{ env.AUTHOR }}

        ğŸ–¥ï¸ *Runner:* GitHub Actions  
        â³ *Status:* Connecting to VPS..."

    # ==========================================
    # STEP 2: SSH -> Pull -> Build -> Deploy
    # ==========================================
    - name: ğŸš¢ Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          set -e
          echo "ğŸš€ Starting Deployment on VPS..."
          
          # Navigate to project directory
          PROJECT_PATH="${{ secrets.PROJECT_PATH }}"
          cd $PROJECT_PATH || { echo "âŒ Directory $PROJECT_PATH not found"; exit 1; }
          
          # Pull latest code
          echo "ğŸ“¥ Pulling latest changes..."
          git fetch origin main
          git reset --hard origin/main
          
          # Build and Start Containers
          echo "ğŸ—ï¸ Building and Starting Containers..."
          docker-compose down
          
          # Build using GOPROXY to bypass geo-blocking
          echo "ğŸ›¡ï¸ Building with GOPROXY..."
          docker-compose build --build-arg GOPROXY=https://goproxy.io,direct
          
          echo "ğŸš€ Starting services..."
          docker-compose up -d
          
          # Cleanup unused images
          docker image prune -f

    # ==========================================
    # STEP 3: Success Notification
    # ==========================================
    - name: âœ… Notify Success
      if: success()
      run: |
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d message_thread_id="2" \
          -d parse_mode="Markdown" \
          -d text="âœ… *Backend Deployment Successful*

        ğŸš€ The application has been successfully built and deployed on the VPS.
        
        ğŸ”— [View Workflow](${{ env.RUN_URL }})"

    # ==========================================
    # STEP 4: Failure Notification
    # ==========================================
    - name: âŒ Notify Failure
      if: failure()
      run: |
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d message_thread_id="2" \
          -d parse_mode="Markdown" \
          -d text="âŒ *Backend Deployment Failed*

        âš ï¸ An error occurred during the deployment process.
        
        ğŸ”— [View Logs](${{ env.RUN_URL }})"
